let choice1 = [
  "Dolphin",
  "is",
  "a",
  "common",
  "name",
  "of",
  "aquatic",
  "mammals",
  "within",
  "the",
  "infraorder",
  "Cetacea.",
  "The",
  "term",
  "dolphin",
  "usually",
  "refers",
  "to",
  "the",
  "extant",
  "families",
  "Delphinidae",
  "(the",
  "oceanic",
  "dolphins),",
  "Platanistidae",
  "(the",
  "Indian",
  "river",
  "dolphins),",
  "Iniidae",
  "(the",
  "New",
  "World",
  "river",
  "dolphins),",
  "and",
  "Pontoporiidae",
  "(the",
  "brackish",
  "dolphins),",
  "and",
  "the",
  "extinct",
  "Lipotidae",
  "(baiji",
  "or",
  "Chinese",
  "river",
  "dolphin).",
  "There",
  "are",
  "40",
  "extant",
  "species",
  "named",
  "as",
  "Dolphins",
  "range",
  "in",
  "size",
  "from",
  "the",
  "1.7-metre-long",
  "(5",
  "ft",
  "7",
  "in)",
  "long",
  "and",
  "50-kilogram",
  "(110-pound)",
  "Maui's",
  "dolphin",
  "to",
  "the",
  "9.5",
  "m",
  "(31",
  "ft",
  "2",
  "in)",
  "and",
  "10-metric-ton",
  "(11-short-ton)",
  "killer",
  "whale.",
  "Several",
  "species",
  "exhibit",
  "sexual",
  "dimorphism,",
  "in",
  "that",
  "the",
  "males",
  "are",
  "larger",
  "than",
  "females.",
  "They",
  "have",
  "streamlined",
  "bodies",
  "and",
  "two",
  "limbs",
  "that",
  "are",
  "modified",
  "into",
  "flippers.",
  "Though",
  "not",
  "quite",
  "as",
  "flexible",
  "as",
  "seals,",
  "some",
  "dolphins",
  "can",
  "travel",
  "at",
  "speeds",
  "29",
  "km/h",
  "(18",
  "mph)",
  "for",
  "short",
  "distances.",
  "Dolphins",
  "use",
  "their",
  "conical",
  "shaped",
  "teeth",
  "to",
  "capture",
  "fast",
  "moving",
  "prey.",
  "They",
  "have",
  "well-developed",
  "hearing",
  "which",
  "is",
  "adapted",
  "for",
  "both",
  "air",
  "and",
  "water",
  "and",
  "is",
  "so",
  "well",
  "developed",
  "that",
  "some",
  "can",
  "survive",
  "even",
  "if",
  "they",
  "are",
  "blind.",
  "Some",
  "species",
  "are",
  "well",
  "adapted",
  "for",
  "diving",
  "to",
  "great",
  "depths.",
  "They",
  "have",
  "a",
  "layer",
  "of",
  "fat,",
  "or",
  "blubber,",
  "under",
  "the",
  "skin",
  "to",
  "keep",
  "warm",
  "in",
  "the",
  "cold",
  "Although",
  "dolphins",
  "are",
  "widespread,",
  "most",
  "species",
  "prefer",
  "the",
  "warmer",
  "waters",
  "of",
  "the",
  "tropic",
  "zones,",
  "but",
  "some,",
  "like",
  "the",
  "right",
  "whale",
  "dolphin,",
  "prefer",
  "colder",
  "climates.",
  "Dolphins",
  "feed",
  "largely",
  "on",
  "fish",
  "and",
  "squid,",
  "but",
  "a",
  "few,",
  "like",
  "the",
  "killer",
  "whale,",
  "feed",
  "on",
  "large",
  "mammals,",
  "like",
  "seals.",
  "Male",
  "dolphins",
  "typically",
  "mate",
  "with",
  "multiple",
  "females",
  "every",
  "year,",
  "but",
  "females",
  "only",
  "mate",
  "every",
  "two",
  "to",
  "three",
  "years.",
  "Calves",
  "are",
  "typically",
  "born",
  "in",
  "the",
  "spring",
  "and",
  "summer",
  "months",
  "and",
  "females",
  "bear",
  "all",
  "the",
  "responsibility",
  "for",
  "raising",
  "them.",
  "Mothers",
  "of",
  "some",
  "species",
  "fast",
  "and",
  "nurse",
  "their",
  "young",
  "for",
  "a",
  "relatively",
  "long",
  "period",
  "of",
  "time.",
  "Dolphins",
  "produce",
  "a",
  "variety",
  "of",
  "vocalizations,",
  "usually",
  "in",
  "the",
  "form",
  "of",
  "clicks",
  "and",
  "Dolphins",
  "are",
  "sometimes",
  "hunted",
  "in",
  "places",
  "such",
  "as",
  "Japan,",
  "in",
  "an",
  "activity",
  "known",
  "as",
  "dolphin",
  "drive",
  "hunting.",
  "Besides",
  "drive",
  "hunting,",
  "they",
  "also",
  "face",
  "threats",
  "from",
  "bycatch,",
  "habitat",
  "loss,",
  "and",
  "marine",
  "pollution.",
  "Dolphins",
  "have",
  "been",
  "depicted",
  "in",
  "various",
  "cultures",
  "worldwide.",
  "Dolphins",
  "occasionally",
  "feature",
  "in",
  "literature",
  "and",
  "film,",
  "as",
  "in",
  "the",
  "film",
  "series",
  "Free",
  "Willy.",
  "Dolphins",
  "are",
  "sometimes",
  "kept",
  "in",
  "captivity",
  "and",
  "trained",
  "to",
  "perform",
  "tricks.",
  "The",
  "most",
  "common",
  "dolphin",
  "species",
  "in",
  "captivity",
  "is",
  "the",
  "bottlenose",
  "dolphin,",
  "while",
  "there",
  "are",
  "around",
  "60",
  "captive",
  "killer",
];

let choices = [choice1];

window.addEventListener("load", init);

//html elements
const ownText = document.querySelector("#ownText");
const minutes = document.querySelector("#minutes");
const currentWords = document.querySelector("#display-words");
const wpmDisplay = document.querySelector("#wpm");
const timer = document.querySelector("#time");
const message = document.querySelector("#status");
const diffSelector = document.querySelector("#diffSelect");
const errors = document.querySelector("#errors");
const log = document.getElementById("log");
const statistics = document.querySelector("#statistics");

//Globals
let input = "";
let errorCount = 0;
let time = 0;
let wpm = 0;
let isPlaying = false;
let isPaused = false; // pause between typing tests
let count = 0; // Position in the story
let plays = 1; // how many times you have played this session
let average = 0; // average wpm
let averageError = 0; // average errors
let errorLog = [];
let words = [];
let totalTime = 60;

// Google Charts
let scores = [["Attempt", "WPM", "Errors"]];
let missedCharacters = [["Character", "Number of Misses"]];

// Initialize the typing test
function init() {
  //load user data
  lSInit();
  //choose which text to type
  chooseText();
  //Load the typing text
  showWord(words);
  //Listen for typing
  document.addEventListener("keydown", spacePressed);
  ownText.addEventListener("input", saveOwnText);
  minutes.addEventListener("input", setTime);
  //tick tock
  typingTime = setInterval(clock, 1000);
}

//unpause button function - displays the input box again once the button is pressed, and resets the displays

function unpause() {
  isPaused = false;
  wpmDisplay.innerHTML = wpm;
  errors.innerHTML = errorCount;
  message.innerHTML =
    "<span class = 'text-white'>When you are ready, begin typing. <span><br>";
  input = "";
  showWord(words);
}

//this function takes the user inputted number of minutes and sets the time to the number of seconds in said number of minutes
function setTime() {
  totalTime = 60 * Number(minutes.value);
}

//this function saves the user inputted text and loads it into the typing test.
function saveOwnText() {
  cText = ownText.value; //current text in ownText textbox
  pText = []; //parsed text
  sWord = ""; //current word to save
  j = 0;
  while (j < cText.length) {
    while (cText[j] !== " " && j < cText.length) {
      sWord = sWord + cText[j];
      j = j + 1;
    }
    pText.push(sWord);
    sWord = "";
    j = j + 1;
  }
  words = pText;
  showWord(words);
}

// choose at random text that displays on screen
function chooseText() {
  let choice = choices.length;
  choice = Math.floor(Math.random() * 100 + 1) % choice;
  words = choices[choice];
}

//Check if the current word in question matches the word typed
function matchWords() {
  message.innerHTML = "";
  if (!isPaused) {
    if (input === words[count] + " " || input === " " + words[count] + " ") {
      return true;
    } else {
      errorLogger();

      return false;
    }
  }
}

//Show the next 8 words in the typing sequence
function showWord(words) {
  // show the first 3 lines of length scrollSize. Start at first line, then proceed to second line, then start scrolling after each line is completed.
  let shownText = "";
  let q = 0;
  let scrollSize = 10;
  for (let i = 0; i < 3; i++) {
    for (let j = 0; j < scrollSize; j++) {
      if (count < scrollSize * 2) {
        q = j + i * scrollSize;
      } else {
        q =
          Math.floor((count - scrollSize) / scrollSize) * scrollSize +
          j +
          i * scrollSize; // the natural multiples of scrollSize contained in count after scrollSize*2 added to the original q.
      }

      if (q === count) {
        shownText += " " + lettersCovered();
      } else {
        if (q < count) {
          shownText +=
            " " +
            "<span style = 'border-radius: 5px; color: gray; '>" +
            words[q] +
            "</span>";
        } else {
          shownText += " " + words[q];
        }
      }
    }
    shownText += "<br>";
  }
  currentWords.innerHTML = shownText;
  style(); // from styling.js
}

//showWords subfunctions

function lettersCovered() {
  let length = input.length;
  let covered = ""; //covered word.
  if (length > 0) {
    for (let i = 0; i < length; i++) {
      if (input[i] === words[count][i]) {
        covered +=
          "<span style = 'border-radius: 5px;' class = 'highlightColor'>" +
          input[i] +
          "</span>";
      } else {
        covered +=
          "<span style = 'border-radius: 5px; color: red;'>" +
          input[i] +
          "</span>";
      }
    }

    for (let j = length; j < words[count].length; j++) {
      covered = covered + words[count][j];
    }
  } else {
    covered =
      "<span style = 'border-radius: 5px;' class = 'highlightColor2'>" +
      " " +
      "</span>" +
      words[count];
  }
  return covered;
}

function clock() {
  if (time < totalTime && isPlaying) {
    // Increase time
    time++;
  } else if (wpm > 0) {
    // Game is over
    isPaused = true;
    isPlaying = false;

    //create button to allow the user to re-enable input when ready
    message.innerHTML =
      "<span>Press the button below to type again!<span><br><br>" +
      '<button class = "btn btn-success" onclick = "unpause()" >Type Again</button><br><br>'; // Need to add set of possible responses here...

    //add the fbsharestring to message
    fbShareString =
      '<p>Click the link below to share your score to facebook and challenge your friends!<p><div id="shareBtn" class="btn btn-info clearfix">Share to Facebook</div>';
    message.innerHTML = message.innerHTML + fbShareString;

    //listen for sharebutton
    document.getElementById("shareBtn").addEventListener("click", share);

    currentWords.innerHTML =
      "<span style = 'border-radius: 3px; padding: 1px 3px 1px 3px' id = 'highlightColor'> <strong>That was a good run! </strong>";
    style();
    count = 0;

    // data for google chart and user data storage

    scores.push([plays, (wpm / totalTime) * 60, (errorCount / totalTime) * 60]); // session storage
    lSStore(); // store user data
    drawChart(scores); //chart

    // Other data to display
    average = averageScore(scores);
    averageErrors = averageErrorCalc(scores);
    statistics.innerHTML =
      "<br><strong>Average WPM: " +
      average +
      "<br>" +
      " Average Errors: " +
      averageErrors +
      "<br>" +
      "Error List: </strong>";

    // Add errors from errorlog to display
    let counter = 0;
    while (counter < errorLog.length) {
      statistics.innerHTML =
        statistics.innerHTML +
        "<br>" +
        (counter + 1) +
        ". " +
        errorLog[counter];
      counter++;
    }
    errorLog = [];
    // Update Game State
    plays += 1;
    time = 0;
    wpm = 0;
    errorCount = 0;
  }
  // Show time
  timer.innerHTML = time;
}

// adds the currently input key to the input string
function inputChanger(e) {
  if (e.keyCode == 32 && e.target == document.body) {
    e.preventDefault();
  }
  if (e.key !== "Shift" && e.key !== "Backspace") {
    input += e.key;
  } else {
    if (e.key === "Backspace") {
      input = input.slice(0, input.length - 1);
    }
  }
}

// Checks if the word typed is equal to the word on the text everytime space is pressed.
function spacePressed(e) {
  inputChanger(e);
  if (!isPaused) {
    showWord(words);
  }

  if (!isPaused) {
    isPlaying = true;
  }

  if (input.includes(" ")) {
    if (matchWords()) {
      if (time < totalTime) {
        wpm++;
        wpmDisplay.innerHTML = Math.round((60 * wpm) / time);
      }
    } else {
      errorCount++;
    }

    input = "";
    if (!isPaused) {
      count = count + 1;
      errors.innerHTML = Math.round((60 * errorCount) / time);
      input = "";
      input.placeholder = "";
    }
    showWords(words);
  }
}

// Charts
function drawChart(dataTable) {
  var data = google.visualization.arrayToDataTable(dataTable);

  var options = {
    //title: 'Your Performance',
    curveType: "function",
    legend: { position: "bottom" },
  };

  var chart = new google.visualization.LineChart(
    document.getElementById("curve_chart")
  );

  chart.draw(data, options);
}

//average wpm calculator

function averageScore(scores) {
  average = 0;
  let i = 1;
  while (i < scores.length) {
    average = average + scores[i][1];
    i++;
  }
  average = average / (scores.length - 1);
  localStorage.setItem("average", average);
  return average;
}

//average errors calculator

function averageErrorCalc(scores) {
  averageError = 0;
  let i = 1;
  while (i < scores.length) {
    averageError = averageError + scores[i][2];
    i++;
  }
  averageError = averageError / (scores.length - 1);
  localStorage.setItem("averageError", averageError);
  return averageError;
}

//Error Log:
// Condition for words match: input.value === words[count] || input.value === " " + words[count]
let matching = true;
let i = 1; // since there is a space appended to the beginning of every word
let j = 0; //our secondary counting variable, but if you do this sort of stuff, I guess you already knew that
let punctuation = [",", '"', "'", ".", "?", "!", ";", ":"];
let symbols = [
  "@",
  "#",
  "$",
  "%",
  "^",
  "&",
  "*",
  "(",
  ")",
  "{",
  "}",
  "[",
  "]",
  "-",
  "_",
  "=",
  "+",
  "\\",
  "/",
  "`",
  "~",
  "<",
  ">",
];
let numbers = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0"];
let determined = false; // determined what kind of char was missed

function errorLogger() {
  i = 0;
  matching = true;
  while (matching) {
    // assign characters to separate variables for testing
    let iChar = input[i]; // current letter in input
    let wChar = words[count][i]; // current letter in displayed word
    if (iChar != wChar) {
      missCharCount(wChar);

      j = 0;
      matching = false; // breaks the loop
      determined = false;
      if (iChar === "Undefined") {
        error =
          "You put a space instead of a '" +
          wChar +
          "' in the word '" +
          words[count] +
          "'<br>Your input: '" +
          input +
          "'.";
        determined = true;
      }
      while (j < punctuation.length && !determined) {
        if (wChar === punctuation[j]) {
          determined = true;
          error =
            "You missed the punctuation here: The '" +
            wChar +
            "' in '" +
            words[count] +
            "'<br>Your input: '" +
            input +
            "'.";
        } else {
          j++;
        }
      }
      if (!determined) {
        j = 0;
        while (j < symbols.length && !determined) {
          if (wChar === symbols[j]) {
            determined = true;
            error =
              "You missed the symbol here: The '" +
              wChar +
              "' in '" +
              words[count] +
              "'<br>Your input: '" +
              input +
              "'.";
          } else {
            j++;
          }
        }
      }
      if (!determined) {
        j = 0;
        while (j < numbers.length && !determined) {
          if (wChar === numbers[j]) {
            determined = true;
            error =
              "You missed the number here: The '" +
              wChar +
              "' in '" +
              words[count] +
              "'<br>Your input: '" +
              input +
              "'.";
          } else {
            j++;
          }
        }
      }
      if (!determined) {
        error =
          "You mispelled: '" +
          words[count] +
          "'<br>Your input: '" +
          input +
          "'.";
      }

      //push error to Error log
      errorLog.push(error);
      if (localStorage.getItem("errors") !== null) {
        localStorage.setItem(
          "errors",
          localStorage.getItem("errors") + "<br>" + words[count]
        );
      } else {
        localStorage.setItem("errors", words[count]);
      }
    } else {
      i++;
    }
  }
}

function missCharCount(charM) {
  // charM is the missed character
  q = 1; // starts at 1 because the first value, or the 0'th value, is ['Missed Characters','Character'] which is for Google charts
  charFound = false;
  while (q < missedCharacters.length) {
    if (charM === undefined || charM === "") {
      // space which is translated to '' from undefined.
      charM = " ";
    }
    if (charM === missedCharacters[q][0]) {
      missedCharacters[q][1] = missedCharacters[q][1] + 1;
      charFound = true;
    }
    console.log("char ", charM);
    q = q + 1;
  }

  if (!charFound && charM !== "") {
    missedCharacters.push([charM, 1]);
  }

  localStorage.setItem("Missed Characters", missedCharacters);
}

// localstorage
function lSStore() {
  if (localStorage.getItem("xp") !== null) {
    localStorage.setItem("xp", Number(localStorage.getItem("xp")) + wpm);
  } else {
    localStorage.setItem("xp", wpm);
  }
  //scores
  localStorage.setItem("scores", scores);
}

function lSInit() {
  //scores
  //delete localStorage.scores;
  if (localStorage.getItem("scores") !== null) {
    let p = 19; // starting here because the first three values are 'attempt,wpm,errors' a total of 18 characters...could fix, but nah..t right now
    let block = [0, 0, 0];
    let scoresTemp = localStorage.getItem("scores");
    while (p < scoresTemp.length) {
      let val = "";
      let q = 0;
      while (q < 3) {
        while (scoresTemp[p] !== "," && p < scoresTemp.length) {
          val = val + scoresTemp[p];
          p = p + 1;
        }
        block[q] = Number(val);
        val = "";
        p = p + 1;
        q = q + 1;
      }
      scores.push([block[0], block[1], block[2]]);
    }

    //Initialize plays to how many times you have typed
    plays = scores.length;
    // draw chart
    drawChart(scores);
  }

  if (localStorage.getItem("Missed Characters") !== null) {
    // any changes to this if must be made in both profile and in wordsPerMinute and in TypeYourOenText.
    let p = 27; // starting here because the first two values are 'Number of Misses,Character,' a total of 27 characters...could fix, but nah..t right now
    let block = ["", 0];
    let charsTemp = localStorage.getItem("Missed Characters");
    while (p < charsTemp.length) {
      let q = 0;
      while (q < 2) {
        if (q % 2 === 0) {
          block[q] = charsTemp[p];
        } else {
          block[q] = Number(charsTemp[p]); // need to convert string count of missed characters to a number.  so '1' to 1.
        }

        p = p + 2; // 2 because there is a comma between each relevant value
        q = q + 1;
      }
      missedCharacters.push([block[0], block[1]]);
    }
  }
}

//fbshare string

function share() {
  let shareString =
    "I just typed " +
    wpmDisplay.innerHTML +
    " words in a single minute! Think you can beat my score?";
  FB.ui(
    {
      display: "popup",
      method: "share",
      href: "https://speedyfingers.net",
      quote: shareString,
    },
    function (response) {}
  );
}
